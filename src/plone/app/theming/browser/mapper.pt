<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    lang="en"
    metal:use-macro="context/prefs_main_template/macros/master"
    i18n:domain="plone">

<head>
<metal:block fill-slot="top_slot">

<tal:defines define="dummy python:request.set('disable_border',1);
                     disable_column_one python:request.set('disable_plone.leftcolumn',1);
                     disable_column_two python:request.set('disable_plone.rightcolumn',1);
                     aceFiles string:${view/portalUrl}/++resource++plone.resourceeditor/ace;">

<!-- ACE editor -->
<script
    type="text/javascript"
    charset="utf-8"
    tal:attributes="src string:${aceFiles}/ace.js"
    ></script>

<!-- Theme -->
<script
    type="text/javascript"
    charset="utf-8"
    tal:attributes="src string:${aceFiles}/theme-textmate.js"
    ></script>

<!-- Syntax highlighting -->
<script
    type="text/javascript"
    charset="utf-8"
    tal:attributes="src string:${aceFiles}/mode-xml.js"
    ></script>
<script
    type="text/javascript"
    charset="utf-8"
    tal:attributes="src string:${aceFiles}/mode-html.js"
    ></script>
<script
    type="text/javascript"
    charset="utf-8"
    tal:attributes="src string:${aceFiles}/mode-css.js"
    ></script>
<script
    type="text/javascript"
    charset="utf-8"
    tal:attributes="src string:${aceFiles}/mode-javascript.js"
    ></script>


<!-- Mapper tools -->
<script
    type="text/javascript"
    charset="utf-8"
    tal:attributes="src string:${view/portalUrl}/++resource++plone.resourceeditor/editor.js"></script>
<script
    type="text/javascript"
    charset="utf-8"
    tal:attributes="src string:${view/portalUrl}/++resource++plone.app.theming/mapper.js"
    ></script>


<!-- Styling for this page -->
<link
    rel="stylesheet"
    type="text/css"
    tal:attributes="href string:${view/portalUrl}/++resource++plone.app.theming/mapper.css"
    />

<script type="text/javascript" tal:content="view/jsVariables"></script>

<script type="text/javascript">

    jQuery(function($) {

        $().ready(function() {

            var WINDOW_BASE = window.location.protocol + '//' + window.location.host;

            var WINDOWED_HEIGHT = '300px';
            var FULLSCREEN_HEIGHT = '600px';

            // Editor management

            var HTMLMode = require("ace/mode/html").Mode;
            var CSSMode  = require("ace/mode/css").Mode;
            var XMLMode  = require("ace/mode/xml").Mode;
            var JSMode   = require("ace/mode/javascript").Mode;
            var TextMode = require("ace/mode/text").Mode;

            var extensionModes = {
                css: new CSSMode(),
                js: new JSMode(),
                htm: new HTMLMode(),
                html: new HTMLMode(),
                xml: new XMLMode()
            };
            var defaultMode = new TextMode();
            var dirties = {}; // which files are dirty?

            function getExtension(path) {
                var m = path.match(/.(\w+)$/);
                if(m == null) return null;
                return m[1];
            }

            // See http://stackoverflow.com/questions/1694295/jquery-background-color-animate-not-working/5718151
            function animateHighlight(node, highlightColor, duration) {
                var highlightBg = highlightColor || "#FFFFE3";
                var animateMs = duration || 750;
                var originalBg = $(node).css("background-color");

                if (!originalBg || originalBg == highlightBg)
                    originalBg = "#FFFFFF"; // default to white

                $(node)
                    .css("backgroundColor", highlightBg)
                    .animate({ backgroundColor: originalBg }, animateMs, null, function () {
                        $(node).css("backgroundColor", originalBg);
                    });
            };

            window.onbeforeunload = function() {
                for(key in dirties) {
                    if(dirties[key]) {
                        return $("#unload-warning-text").text();
                    }
                }
            };

            if($.browser.msie) {
                $(".ie-warning").show();
            }

            // Help and preview
            $("#preview").click(function() {
              window.open($(this).attr("data-href"), "preview");
              return false;
            });

            $("#helpButtonForm").prepOverlay({
                subtype: 'iframe'
            });

            // Rule builder and highlighters

            var ruleBuilder = null;
            var rulesEditor = null;
            var themeFrameHighlighter = null;
            var contentFrameHighlighter = null;

            $("#new-rule").overlay({
                closeOnClick: false,
                onBeforeClose: function() {
                    if(ruleBuilder.active && $("#new-rule-step-2").is(":visible")) {
                        ruleBuilder.end();
                        if(rulesEditor !== null)
                            rulesEditor.focus();
                    }
                }
            });
            var ruleBuilderOverlay = $("#new-rule").data('overlay');

            if($("#file-contents").length > 0) {
                rulesEditor = new SourceEditor('editor', extensionModes.html, $("#file-contents").text(), !EDITABLE,
                    function() {
                        dirties['rules.xml'] = true;
                        $("#rules-editor .dirtyMarker").show();
                    }
                );
            }

            themeFrameHighlighter = new FrameHighlighter("#theme-frame",
                function(highlighter, node) { // onselect
                    $("#theme-frame-info").text(node == null? "" : ruleBuilder.bestSelector(node));
                },
                function(highlighter, node) { // onsave
                    if(node == null) {
                        $("#theme-frame-shelf-container").hide();
                    } else {
                        $("#theme-frame-shelf-container").show();
                    }

                    animateHighlight($("#theme-panel .frame-info"));
                    $("#theme-frame-shelf").text(node == null? "" : ruleBuilder.bestSelector(node));

                    if(ruleBuilder.active && ruleBuilder.currentScope == "theme") {
                        ruleBuilder.select(node);
                        ruleBuilder.next();
                    }

                }
            );

            contentFrameHighlighter = new FrameHighlighter("#content-frame",
                function(highlighter, node) { // onselect
                    $("#content-frame-info").text(node == null? "" : ruleBuilder.bestSelector(node));
                },
                function(highlighter, node) { // onsave
                    if(node == null) {
                        $("#content-frame-shelf-container").hide();
                    } else {
                        $("#content-frame-shelf-container").show();
                    }

                    animateHighlight($("#content-panel .frame-info"));
                    $("#content-frame-shelf").text(node == null? "" : ruleBuilder.bestSelector(node));

                    if(ruleBuilder.active && ruleBuilder.currentScope == "content") {
                        ruleBuilder.select(node);
                        ruleBuilder.next();
                    }
                }
            );

            ruleBuilder = new RuleBuilder(function(ruleBuilder) {
                $(".wizard-text").css('display', 'none');
                $.mask.close();

                if(ruleBuilder.currentScope == 'theme') {
                    if(ruleBuilderOverlay.isOpened()) {
                        ruleBuilderOverlay.close();
                    }

                    if(themeFrameHighlighter.saved != null) {
                        // Use saved rule
                        ruleBuilder.select(themeFrameHighlighter.saved);
                        ruleBuilder.next();
                    } else {
                        // Let the frame highlighter perform a selection
                        $("#new-rule-text-select-theme").show();
                        $("#theme-panel, .wizard-text").expose();
                    }

                } else if(ruleBuilder.currentScope == 'content') {
                    if(ruleBuilderOverlay.isOpened()) {
                        ruleBuilderOverlay.close();
                    }

                    if(contentFrameHighlighter.saved != null) {
                        // Use saved rule
                        ruleBuilder.select(contentFrameHighlighter.saved);
                        ruleBuilder.next();
                    } else {
                        // Let the frame highlighter perform a selection
                        $("#new-rule-text-select-content").show();
                        $("#content-panel, .wizard-text").expose();
                    }

                } else if(ruleBuilder.ruleType != null && ruleBuilder.currentScope == null) {
                    $("#new-rule-step-1").hide();
                    $("#new-rule-step-2").show();
                    updateRule(ruleBuilder);

                    if(!ruleBuilderOverlay.isOpened()) {
                        ruleBuilderOverlay.load();
                    }

                } else { // end

                    if(ruleBuilderOverlay.isOpened()) {
                        ruleBuilderOverlay.close();
                    }

                    $("#new-rule-step-1").show();
                    $("#new-rule-step-2").hide();


                }
            });

            function updateRule(ruleBuilder) {
                $("#new-rule-output").val(
                    ruleBuilder.buildRule(
                        $('#new-rule-theme-children').is(':checked'),
                        $('#new-rule-content-children').is(':checked')
                    )
                );
            }

            $(".wizard-cancel").click(function() {
                ruleBuilder.end();
                return false;
            });

            $(".rule-modifier").change(function() {
                updateRule(ruleBuilder);
            });

            $("#new-rule-step-1 .next").click(function() {
                var ruleType = $("input[name='new-rule-type']:checked").val();
                ruleBuilder.start(ruleType);
            });

            // The insert wizard doesn't work well in IE where we use plain
            // textareas, but we offer a copy-to-clipboard button instead
            if($.browser.msie) {
                $("#new-rule-step-2 .insert").hide();
                $("#new-rule-step-2 .copy").click(function() {
                    window.clipboardData.setData('Text', $("#new-rule-output").val());
                    ruleBuilderOverlay.close();
                });
            } else {
                $("#new-rule-step-2 .copy").hide();
                $("#new-rule-step-2 .insert").click(function() {

                    var rule = $("#new-rule-output").val();

                    // Get the underlying ACE editor: no IE support for this anyway
                    var aceEditor = rulesEditor.ace;

                    function findStartTag(backwards) {
                        aceEditor.find("<\\w+", {
                            backwards: backwards,
                            wrap: false,
                            wholeWord: false,
                            regExp: true
                        });
                    }

                    function indent(string, amount) {
                        var padding = '';
                        for(var i = 0; i < amount; ++i) {
                            padding += ' ';
                        }
                        return padding + string.replace(/\n/g, '\n' + padding) + '\n\n';
                    }

                    // Go to the next opening tag - we want to insert before this
                    findStartTag(false);
                    if(aceEditor.getCursorPosition().row <= 1) {
                        // Probably the opening rules tag
                        findStartTag(false);
                    }

                    var selectionText = aceEditor.getSession().getTextRange(aceEditor.getSelectionRange());

                    // If we didn't find anything, look for the end of the current tag
                    if(selectionText == "") {

                        aceEditor.find("(/>|<" + "/)", {
                            backwards: false,
                            wrap: false,
                            wholeWord: false,
                            regExp: true
                        });

                        var selectionText = aceEditor.getSession().getTextRange(aceEditor.getSelectionRange());
                        if(selectionText == "") {
                            // Still nothing? Go to the end
                            aceEditor.navigateFileEnd();
                        } else {
                            // Go one past the end tag, but first figure out how far we should i
                            aceEditor.navigateDown();
                        }

                    }

                    var indentation = aceEditor.getSelectionRange().start.column;

                    var cursorPosition = aceEditor.getCursorPosition();
                    var newlines = rule.match(/\n/g);
                    var rows = 0;
                    if(newlines != null) {
                        rows = newlines.length;
                    }

                    aceEditor.navigateTo(cursorPosition.row, 0);
                    aceEditor.insert(indent(rule, indentation));
                    aceEditor.navigateTo(cursorPosition.row, 0);
                    aceEditor.getSelection().selectTo(cursorPosition.row + rows + 1, 0);
                    rulesEditor.focus();
                    dirties['rules.xml'] = true;
                    $("#rules-editor .dirtyMarker").show();

                    ruleBuilderOverlay.close();
                });
            }

            // Fullscreen

            $(".fullscreen").click(function(event) {
                event.preventDefault();
                $(this).toggleClass("fullscreenActive");
                return false;
            });

            // View source

            $(".sourceToggle").click(function(event) {
                event.preventDefault();
                $(this).toggleClass("sourceActive");
                return false;
            });

            // Rules editor

            (function() {

                $("#rules-save").click(function() {

                    var data = rulesEditor.getValue();
                    $("#file-contents").val(data);

                    $.ajax({
                        url: THEME_BASE_URL + '/@@theming-controlpanel-mapper-save',
                        data: {value: data},
                        type: 'POST',
                        success: function(){
                            dirties['rules.xml'] = false;
                            $("#rules-editor .dirtyMarker").hide();
                            rulesEditor.focus();
                        }
                    });
                });

                $("#rules-editor .fullscreen").click(function(event) {
                    event.preventDefault();

                    if($("#editor").css('height') == FULLSCREEN_HEIGHT) {
                        $("#theme-content-row").show();
                        $("#page-intro").show();
                        $("#editor").css('height', WINDOWED_HEIGHT);
                        rulesEditor.resize();
                    } else {
                        $("#theme-content-row").hide();
                        $("#page-intro").hide();
                        $("#editor").css('height', FULLSCREEN_HEIGHT);
                        rulesEditor.resize();
                    }

                    return false;
                });
            })();

            // Theme panel
            (function() {

                var themeSource = new SourceEditor('theme-source', extensionModes.html, "", true);

                function reloadFrame() {
                    var path = $("#file-selector option:selected").val();
                    var fetch = THEME_BASE_URL + "/@@theming-controlpanel-mapper-getframe?path=" + path + "&amp;theme=off";
                    $("#theme-frame").attr('src', fetch);
                }

                function reloadSource() {
                    var html = $("#theme-frame").contents().find(":root").html();
                    themeSource.setValue("<" + "html>\n" + html + '\n<' + '/html>');
                    themeSource.resize();
                }

                $("#theme-frame").ready(function() {
                    function setup() {
                        themeFrameHighlighter.setupElements();
                        reloadSource();
                    }
                    setup();
                    $("#theme-frame").load(setup);
                });

                $("#file-selector").change(function() {
                    reloadFrame();
                });

                $("#theme-frame").show();
                $("#theme-source").hide();

                $("#theme-panel .sourceToggle").click(function() {
                    if($("#theme-frame").is(":visible")) {
                        $("#theme-frame").hide();
                        $("#theme-source").show();
                        $("#theme-footer-help").hide();
                        $("#theme-panel .inspector-switch").hide();
                        reloadSource();
                        themeSource.focus();
                    } else {
                        $("#theme-frame").show();
                        $("#theme-source").hide();
                        $("#theme-footer-help").show();
                        $("#theme-panel .inspector-switch").show();
                    }
                });

                $("#theme-inspector-on").click(function() {
                    themeFrameHighlighter.enabled = true;
                    $("#theme-inspector-on").attr('disabled', 'disabled');
                    $("#theme-inspector-off").removeAttr('disabled');
                    $("#theme-footer-help").show();
                });
                $("#theme-inspector-off").click(function() {
                    themeFrameHighlighter.enabled = false;
                    $("#theme-inspector-off").attr('disabled', 'disabled');
                    $("#theme-inspector-on").removeAttr('disabled');
                    $("#theme-footer-help").hide();
                });

                $("#theme-panel .fullscreen").click(function(event) {
                    event.preventDefault();

                    if($("#theme-panel").is(".width-full")) {
                        $("#content-panel").show();
                        $("#rules-results-row").show();
                        $("#page-intro").show();
                        $("#theme-panel").removeClass('width-full').addClass('width-1:2');
                        $("#theme-panel iframe").removeClass('fullscreen-frame');
                        $("#theme-source").css('height', WINDOWED_HEIGHT);
                        themeSource.resize();
                    } else {
                        $("#content-panel").hide();
                        $("#rules-results-row").hide();
                        $("#page-intro").hide();
                        $("#theme-panel").removeClass('width-1:2').addClass('width-full');
                        $("#theme-panel iframe").addClass('fullscreen-frame');
                        $("#theme-source").css('height', FULLSCREEN_HEIGHT);
                        themeSource.resize();
                    }

                    return false;
                });

                $("#theme-frame-shelf-clear").click(function() {
                    themeFrameHighlighter.save(null);
                    return false;
                });

            })();

            // Content panel
            (function() {

                var contentSource = new SourceEditor('content-source', extensionModes.html, "", true);

                $("#content-frame").ready(function() {
                    var linkManager = new LinkManager("#content-frame", 'off',  WINDOW_BASE, THEME_BASE_URL);
                    function setup() {
                        contentFrameHighlighter.setupElements();
                        linkManager.setupLinks();
                        linkManager.setupForms();
                    }
                    setup();
                    $("#content-frame").load(setup);
                });

                $("#content-frame").show();
                $("#content-source").hide();

                $("#content-panel .sourceToggle").click(function() {
                    if($("#content-frame").is(":visible")) {
                        var html = $("#content-frame").contents().find(":root").html();
                        contentSource.setValue("<" + "html>\n" + html + '\n<' + '/html>');
                        $("#content-frame").hide();
                        $("#content-source").show();
                        $("#content-footer-help").hide();
                        $("#content-panel .inspector-switch").hide();
                        contentSource.resize();
                        contentSource.focus();
                    } else {
                        $("#content-frame").show();
                        $("#content-source").hide();
                        $("#content-footer-help").show();
                        $("#content-panel .inspector-switch").show();
                    }
                });

                $("#content-inspector-on").click(function() {
                    contentFrameHighlighter.enabled = true;
                    $("#content-inspector-on").attr('disabled', 'disabled');
                    $("#content-inspector-off").removeAttr('disabled');
                    $("#content-footer-help").show();
                });
                $("#content-inspector-off").click(function() {
                    contentFrameHighlighter.enabled = false;
                    $("#content-inspector-off").attr('disabled', 'disabled');
                    $("#content-inspector-on").removeAttr('disabled');
                    $("#content-footer-help").hide();
                });

                $("#content-panel .fullscreen").click(function(event) {
                    event.preventDefault();

                    if($("#content-panel").is(".width-full")) {
                        $("#theme-panel").show();
                        $("#rules-results-row").show();
                        $("#page-intro").show();
                        $("#content-panel").removeClass('width-full')
                                           .removeClass('position-0')
                                           .addClass('width-1:2')
                                           .addClass('position-1:2');

                        $("#content-panel iframe").removeClass('fullscreen-frame');
                        $("#content-source").css('height', WINDOWED_HEIGHT);
                        contentSource.resize();
                    } else {
                        $("#theme-panel").hide();
                        $("#rules-results-row").hide();
                        $("#page-intro").hide();
                        $("#content-panel").removeClass('width-1:2')
                                           .removeClass('position-1:2')
                                           .addClass('width-full')
                                           .addClass('position-0');

                        $("#content-panel iframe").addClass('fullscreen-frame');
                        $("#content-source").css('height', FULLSCREEN_HEIGHT);
                        contentSource.resize();
                   }

                    return false;
                });

                $("#content-frame-shelf-clear").click(function() {
                    contentFrameHighlighter.save(null);
                    return false;
                });

            })();

            // Key bindings
            (function() {

                var canon = require('pilot/canon');

                if(rulesEditor !== null) {
                    canon.addCommand({
                        name: 'saveEditor',
                        bindKey: {
                            mac: 'Command-S',
                            win: 'Ctrl+S',
                            sender: 'editor'
                        },
                        exec: function(env, args, request) {
                            if($(env.editor.container).is("#theme-source")) {
                                $("#theme-save").click();
                            } else if($(env.editor.container).is("#editor")) {
                                $("#rules-save").click();
                            }
                        }
                    });
                }

                canon.addCommand({
                    name: 'newRule',
                    bindKey: {
                        mac: 'Command-N',
                        win: 'Ctrl+N',
                        sender: 'editor'
                    },
                    exec: function(env, args, request) {
                        $("#new-rule").click();
                    }
                });

                canon.addCommand({
                    name: 'rulesHelp',
                    bindKey: {
                        mac: 'Command-H',
                        win: 'Ctrl+H',
                        sender: 'editor'
                    },
                    exec: function(env, args, request) {
                        $("#helpButtonForm").submit();
                    }
                });

            })();

        });

    });

</script>
</tal:defines>

</metal:block>
</head>

<body>
<div metal:fill-slot="prefs_configlet_content" class="documentEditable" id="themeMapper">

    <div metal:use-macro="context/global_statusmessage/macros/portal_message">
      Portal status message
    </div>

    <dl class="portalMessage warning" tal:condition="python:view.active and view.editable">
        <dt i18n:translate="">Warning</dt>
        <dd i18n:translate="theming_mapper_warning_live">
            This theme is currently active. Any changes made will be immediately
            reflected on the live site.
        </dd>
    </dl>

    <div id="content">


        <div id="page-intro">

            <h1 class="documentFirstHeading"
                i18n:translate="heading_theme_mapper">Map rules for
                <span i18n:name="name" tal:content="view/title">name</span>
                <span i18n:name="readonly" i18n:translate="" tal:condition="not:view/editable">(read-only)</span>
            </h1>

            <a href=""
                class="link-parent"
                tal:attributes="href string:${portal_url}/@@theming-controlpanel"
                i18n:translate="label_up_to_theming_controlpanel">
                    Back to the control panel
            </a>
            <tal:block condition="view/editable">
                |
                <a href=""
                    class="link-parent"
                    tal:attributes="href string:${portal_url}/++theme++${view/name}/@@theming-controlpanel-filemanager"
                    i18n:translate="label_up_to_theming_mapper">
                        Launch file manager
                </a>
            </tal:block>

            <dl class="portalMessage info wizard-text" id="new-rule-text-select-theme">
                <dt i18n:translate="">New rule</dt>
                <dd i18n:translate="theming_mapper_select_theme">
                    Please select an element in the "HTML mockup" panel.
                    <button class="wizard-cancel allowMultiSubmit">Cancel</button>
                </dd>
            </dl>
            <dl class="portalMessage info wizard-text" id="new-rule-text-select-content">
                <dt i18n:translate="">New rule</dt>
                <dd i18n:translate="theming_mapper_select_content">
                    Please select an element in the "Unthemed content" panel.
                    <button class="wizard-cancel allowMultiSubmit">Cancel</button>
                </dd>
            </dl>

            <p class="discreet"
                i18n:translate="help_theme_mapper_overview_editable"
                tal:condition="view/editable">
                Use the rules editor at the bottom of this screen to edit theme
                rules. Hover over elements in the <strong>HTML mockup</strong> or
                <strong>Unthemed content</strong> panels to discover theme
                selectors. Click <strong>New rule</strong> to
                create and insert rules using a point-and-click wizard.
            </p>

            <p class="discreet"
                i18n:translate="help_theme_mapper_overview_not_editable"
                tal:condition="not:view/editable">
                Hover over elements in the <strong>HTML mockup</strong> or
                <strong>Unthemed content</strong> panels to discover theme
                selectors. Click <strong>New rule</strong> to
                create rules using a point-and-click wizard, which you can copy
                into a <code>rules.xml</code> file on the filesystem.
            </p>

            <dl style="display: none" class="ie-warning portalMessage warning">
                <dt i18n:translate="">Warning</dt>
                <dd i18n:translate="theming_mapper_warning_ie">
                    You are using Internet Explorer. The theme mapper will work,
                    but some functionality will not be available. We recommend that
                    you use Mozilla Firefox or Google Chrome instead.
                </dd>
            </dl>

            <div class="globalToolbar">

                <button
                    id="new-rule"
                    name="form.button.BuildRule"
                    class="allowMultiSubmit"
                    rel="#new-rule-wizard"
                    title="Ctrl+N (Windows/Linux) or Cmd+N (Mac)"
                    i18n:attributes="title"
                    i18n:translate=""
                    >New rule</button>

                <button id="preview" name="preview" type="button" i18n:translate="filemanager_preview_theme"
                    title="Open a preview of the theme in a new window. Forms will be disabled in the preview." i18n:attributes="title [filemanager_preview_theme_help]"
                    tal:attributes="data-href string:${view/portalUrl}/++theme++${view/name}/@@theming-controlpanel-mapper-getframe?path=/&amp;theme=apply&amp;forms=disable&amp;links=replace&amp;title=Preview:+${view/title}">Preview theme</button>

                <form id="helpButtonForm" method="get" tal:attributes="action string:${portal_url}/@@theming-controlpanel-help">
                    <button
                        class="standalone"
                        i18n:translate="">Help</button>
                </form>

            </div>

        </div>

        <div id="theme-content-row" class="row splitview">
            <div id="theme-panel" class="mapper-box cell width-1:2 position-0">

                <div class="panel-toolbar">

                    <a class="sourceToggle" href="#" title="Toggle source view" i18n:attributes="title">&nbsp;</a>
                    <a class="fullscreen" href="#" title="Toggle fullscreen" i18n:attributes="title">&nbsp;</a>
                </div>

                <label i18n:translate="heading_theme">HTML mockup</label>

                <iframe id="theme-frame"
                    tal:attributes="src string:${view/themeBaseUrl}/@@theming-controlpanel-mapper-getframe?path=/${view/themeBasePathEncoded}/${view/defaultThemeFile}&amp;theme=off"></iframe>
                <pre class="source-editor" id="theme-source"></pre>

                <div class="frame-info">
                    <div id="theme-frame-shelf-container" class="frame-shelf" style="display:none">
                        <span i18n:translate="theming_mapper_shelf_label">Selected:</span>
                        <span class="shelf" id="theme-frame-shelf"></span>
                        <a class="clear-shelf" id="theme-frame-shelf-clear" href="#clear"
                            title="Clear selection" i18n:attributes="title">x</a>
                    </div>
                    <span id="theme-frame-info"></span>
                </div>

                <div class="panel-footer">
                    <div class="inspector-switch">
                        <button id="theme-inspector-on" disabled="disabled">Inspector on</button>
                        <button id="theme-inspector-off">Inspector off</button>
                    </div>
                    <tal:block condition="python:len(view.themeFiles) > 1">
                        <label for="file-selector">Switch file:</label>
                        <select size="1" name="file-selector" id="file-selector">
                            <option
                                tal:repeat="f view/themeFiles"
                                tal:attributes="value string:${view/themeBasePathEncoded}/${f/path};
                                                data-path f/path;
                                                data-extension f/extension;
                                                selected python:f['path'] == view.defaultThemeFile and 'selected' or None"
                                tal:content="f/path"
                                />
                        </select>
                    </tal:block>
                </div>

                <div id="theme-footer-help" class="discreet footer-help" i18n:translate="help_highlighter_selection">
                    Hover over an element to see its selector.
                    Left-click or press <em>Enter</em> to save.
                    Press <em>Esc</em> to select parent.
                </div>

            </div>
            <div id="content-panel" class="mapper-box cell width-1:2 position-1:2">

                <div class="panel-toolbar">
                    <a class="sourceToggle" href="#" title="Toggle source view" i18n:attributes="title">&nbsp;</a>
                    <a class="fullscreen" href="#" title="Toggle fullscreen" i18n:attributes="title">&nbsp;</a>
                </div>

                <label i18n:translate="heading_content">Unthemed content</label>

                <iframe id="content-frame"
                    tal:attributes="src string:${view/themeBaseUrl}/@@theming-controlpanel-mapper-getframe?path=/&amp;theme=off"></iframe>
                <pre class="source-editor" id="content-source"></pre>

                <div class="frame-info">
                    <div id="content-frame-shelf-container" class="frame-shelf" style="display:none">
                        <span i18n:translate="theming_mapper_shelf_label">Selected:</span>
                        <span class="shelf" id="content-frame-shelf">(none)</span>
                        <a class="clear-shelf" id="content-frame-shelf-clear" href="#clear"
                            title="Clear selection" i18n:attributes="title">x</a>
                    </div>
                    <span id="content-frame-info"></span>
                </div>

                <div class="panel-footer">
                    <div class="inspector-switch">
                        <button id="content-inspector-on" disabled="disabled">Inspector on</button>
                        <button id="content-inspector-off">Inspector off</button>
                    </div>
                </div>

                <div id="content-footer-help" class="discreet footer-help" i18n:translate="help_highlighter_selection">
                    Hover over an element to see its selector.
                    Left-click or press <em>Enter</em> to save.
                    Press <em>Esc</em> to select parent.
                </div>

            </div>
        </div>

        <div id="rules-results-row" class="row splitview" tal:condition="view/editable">
            <div id="rules-editor" class="mapper-box cell width-full position-0">

                <div id="mapper-toolbar" class="panel-toolbar">
                    <button
                        tal:condition="view/editable"
                        id="rules-save"
                        name="form.button.Save"
                        class="allowMultiSubmit"
                        title="Ctrl+S (Windows/Linux) or Cmd+S (Mac)"
                        i18n:attributes="title"
                        i18n:translate=""
                        >Save</button>

                    <a class="fullscreen" href="#" title="Toggle fullscreen" i18n:attributes="title">&nbsp;</a>

                </div>

                <label i18n:translate="heading_rules">Theme rules</label>
                <span class="dirtyMarker" style="display:none" title="Unsaved changes" i18n:attributes="title">*</span>

                <pre id="editor"></pre>
                <textarea id="file-contents" class="hiddenStructure" name="rules"
                    tal:content="view/rules"></textarea>

            </div>
        </div>

        <div id="unload-warning-text" class="hiddenStructure" i18n:translate="theming_mapper_unload_warning">Are you sure you want to leave this page? Unsaved changes will be lost.</div>

        <!-- Wizard overlay -->
        <div id="new-rule-wizard" class="overlay overlay-ajax">
            <div class="close">
                <span i18n:translate="">Close</span>
            </div>
            <div class="pb-ajax">
                <div class="new-rule">
                    <h1 class="documentFirstHeading" i18n:translate="theming_mapper_heading_newrule">New rule</h1>

                    <div id="new-rule-step-1">
                        <div class="documentDescription" i18n:translate="theming_mapper_wizard_step1">
                            Choose the operation you would like to perform
                        </div>

                        <form>
                            <div id="new-rule-type-panel">
                                <div>
                                    <input type="radio" name="new-rule-type" value="replace" id="new-rule-replace" checked="checked" />
                                    <label for="new-rule-replace" i18n:translate="theming_mapping_wizard_replace">
                                        <strong>Replace</strong> an element of the theme with an element from the content
                                    </label>
                                </div>
                                <div>
                                    <input type="radio" name="new-rule-type" value="before" id="new-rule-before" />
                                    <label for="new-rule-before" i18n:translate="theming_mapping_wizard_before">
                                        Insert an element from the content <strong>before</strong> an element in the theme
                                    </label>
                                </div>
                                <div>
                                    <input type="radio" name="new-rule-type" value="after" id="new-rule-after" />
                                    <label for="new-rule-after" i18n:translate="theming_mapping_wizard_after">
                                        Insert an element from the content <strong>after</strong> an element in the theme
                                    </label>
                                </div>
                                <div>
                                    <input type="radio" name="new-rule-type" value="drop:content" id="new-rule-drop-content" />
                                    <label for="new-rule-drop-content" i18n:translate="theming_mapping_wizard_drop_content">
                                        <strong>Drop</strong> an element in the <strong>content</strong>
                                    </label>
                                </div>
                                <div>
                                    <input type="radio" name="new-rule-type" value="drop:theme" id="new-rule-drop-theme" />
                                    <label for="new-rule-drop-theme" i18n:translate="theming_mapping_wizard_drop_theme">
                                        <strong>Drop</strong> an element in the <strong>theme</strong>
                                    </label>
                                </div>
                            </div>
                        </form>

                        <div class="formControls new-rule-actions">
                            <input type="submit" class="allowMultiSubmit context next" i18n:attributes="value" value="Next" />
                            <input type="submit" class="allowMultiSubmit standalone close" i18n:attributes="value" value="Cancel" />
                        </div>

                    </div>
                    <div id="new-rule-step-2" style="display:none">
                        <div class="documentDescription" i18n:translate="theming_mapper_wizard_step2">
                            The rule can be found below. Use the checkboxes
                            to further refine it.
                        </div>
                        <form>
                            <div id="new-rule-output-panel">
                                <textarea name="new-rule-output" id="new-rule-output"></textarea>
                            </div>
                            <div id="new-rule-selector-panel">
                                <div>
                                    <input type="checkbox" class="rule-modifier" name="new-rule-theme-children" value="replace" id="new-rule-theme-children" />
                                    <label for="new-rule-theme-children" i18n:translate="">Apply rule to children of the matched theme node(s)</label>
                                </div>
                                <div>
                                    <input type="checkbox" class="rule-modifier" name="new-rule-content-children" value="replace" id="new-rule-content-children" />
                                    <label for="new-rule-content-children" i18n:translate="">Apply rule to children of the matched content node(s)</label>
                                </div>
                            </div>

                        </form>

                        <div class="formControls new-rule-actions">
                            <input type="submit" class="allowMultiSubmit context insert" i18n:attributes="value" tal:condition="view/editable" value="Insert" />
                            <input type="submit" class="allowMultiSubmit context copy" i18n:attributes="value" value="Copy to clipboard" />
                            <input type="submit" class="allowMultiSubmit standalone close" i18n:attributes="value" value="Close" />
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>

</div>
</body>
</html>
