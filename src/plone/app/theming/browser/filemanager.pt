<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    lang="en"
    metal:use-macro="context/prefs_main_template/macros/master"
    i18n:domain="plone">

<head>
<metal:block fill-slot="top_slot" tal:define="resourceDirectory nocall:view/resourceDirectory">

<tal:defines define="dummy python:request.set('disable_border',1);
                     disable_column_one python:request.set('disable_plone.leftcolumn',1);
                     disable_column_two python:request.set('disable_plone.rightcolumn',1);" />

<link rel="stylesheet" type="text/css"
  tal:attributes="href string:${view/portalUrl}/++resource++plone.app.theming/mapper.css"
  />

<metal:block use-macro="resourceDirectory/@@plone.resourceeditor.filemanager/macros/resources" />
<script type="text/javascript" tal:content="view/jsVariables"></script>
<script type="text/javascript">
jQuery(function($) {

  $().ready(function() {

    function normalizePath(path) {
      if(path[0] == '/') {
          path = path.slice(1, path.length);
        }
        return path;
    }

    function isPreviewable(path) {
      return path.match(/.+\.html?$/i);
    }

    // Preview overlay
    $("#preview").click(function() {
      window.open($(this).attr("data-href"), "preview");
      return false;
    });

    // View mockup overlay
    $("#viewMockup").click(function() {
      window.open($(this).attr('data-href'), "mockup");
      return false;
    });

    // Help overlay
    $("#helpButtonForm").prepOverlay({
        subtype: 'iframe'
    });

    $("#filemanager").bind('resourceeditor.selected', function(event, path) {
      if(isPreviewable(path)) {
        $("#viewMockup").removeAttr('disabled');
        var fetch = THEME_BASE_URL + "/@@theming-controlpanel-mapper-getframe?path=" + normalizePath(path) + "&amp;theme=off";
        $("#viewMockup").attr('data-href', fetch);
      } else {
        $("#viewMockup").attr('disabled', 'disabled');
      }
    });

    $("#filemanager").bind('resourceeditor.closed', function(event, path) {
      $("#viewMockup").attr('disabled', 'disabled');
    });

  });

});
</script>

</metal:block>
</head>

<body>
<div metal:fill-slot="prefs_configlet_content" class="documentEditable" tal:define="resourceDirectory nocall:view/resourceDirectory">

    <div metal:use-macro="context/global_statusmessage/macros/portal_message">
      Portal status message
    </div>

    <dl class="portalMessage warning" tal:condition="view/active">
        <dt i18n:translate="">Warning</dt>
        <dd i18n:translate="theming_mapper_warning_live">
            This theme is currently active. Any changes made will be immediately
            reflected on the live site.
        </dd>
    </dl>

    <div id="content">

      <h1 class="documentFirstHeading"
          i18n:translate="heading_edit_theme">Manage files for
          <span i18n:name="name" tal:content="view/title">name</span></h1>

      <a href=""
          class="link-parent"
          tal:attributes="href string:${portal_url}/@@theming-controlpanel"
          i18n:translate="label_up_to_theming_controlpanel">
              Back to the control panel
      </a>
      |
      <a href=""
          class="link-parent"
          tal:attributes="href string:${portal_url}/++theme++${view/name}/@@theming-controlpanel-mapper"
          i18n:translate="label_up_to_theming_mapper">
              Launch theme mapper
      </a>

      <p class="discreet" i18n:translate="help_theme_filemanager">
          You can edit files in the theme by opening them from the file
          tree. Use the buttons on the toolbar to create new folders and
          files. Right-click on items in the file tree to download,
          delete or rename them.
      </p>

      <metal:block use-macro="resourceDirectory/@@plone.resourceeditor.filemanager/macros/filemanager">
        <metal:block fill-slot="extraButtons">
          <button id="preview" name="preview" type="button" i18n:translate="filemanager_preview_theme"
              title="Open a preview of the theme in a new window. Forms will be disabled in the preview." i18n:attributes="title [filemanager_preview_theme_help]"
              tal:attributes="data-href string:${view/portalUrl}/++theme++${view/name}/@@theming-controlpanel-mapper-getframe?path=/&amp;theme=apply&amp;forms=disable&amp;links=replace&amp;title=Preview:+${view/title}">Preview theme</button>
          <form id="helpButtonForm" method="get" tal:attributes="action string:${portal_url}/@@theming-controlpanel-help">
                <button
                  class="standalone"
                  i18n:translate="">Help</button>
          </form>
        </metal:block>
        <metal:block fill-slot="extraContextButtons">
          <button id="viewMockup" name="viewMockup" type="button" disabled="disabled" i18n:translate="filemanager_view_mockup"
            title="Click this button when editing an HTML file to show it in a new window" i18n:attributes="title [filemanager_view_mockup_help]">Show mockup</button>
        </metal:block>
      </metal:block>


  </div>

</div>
</body>
</html>
